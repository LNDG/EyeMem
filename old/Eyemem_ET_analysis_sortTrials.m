function [trl, event] = Eyemem_sortTrials(cfg)% make trl, columns:  1) start, 2) end, 3) offset, % 4) study/test, 5) stimcategory, 6) picno, % 7) quizpic (nan for test), 8) old/new 9) resp button, 9) 10) RThdr    = cfg.headerfile;fsr    = cfg.fsample;         % in Hztrg    = cfg.trialdef.trg;    % 'stim' or 'resp' or 'baseline'begtrl = cfg.trialdef.begtim; % in secondsendtrl = cfg.trialdef.endtim; % in secondsevent = cfg.event;% trgval = {event( find(strcmp('Trial',{event.type})) ).value};% trgsmp = [event( find(strcmp('Trial',{event.type})) ).sample];trgval = {event( find(strcmp('Stim',{event.type}) | strcmp('Response',{event.type})) ).value};trgsmp = [event( find(strcmp('Stim',{event.type}) | strcmp('Response',{event.type})) ).sample];temp = tokenize(char( {event( find(strcmp(['Subj' num2str(cfg.subjno)] ,{event.type})) ).value} ));runinfo=[];runinfo.subjno = cfg.subjno;runinfo.hand = str2num(temp{4}(5));runinfo.phase = temp{5}(1:end-2);runinfo.runno = str2num(temp{7}(4));runinfo.category = temp{6};disp(runinfo.hand)% find stim onset triggersstimstartend = strfind(trgval, ['Stim ' runinfo.category]); stimstartend_index = find(not(cellfun('isempty', stimstartend)));stimstart = strfind(trgval, 'Start');stimstart_index = find(not(cellfun('isempty', stimstart)));trig_ind_stim = intersect(stimstartend_index,stimstart_index);% create trl matrixtrl = zeros(length(trig_ind_stim), 10);trl(:,1) = round(trgsmp(trig_ind_stim)' + begtrl*fsr); % find stim onset samplestrl(:,2) = round(trgsmp(trig_ind_stim)' + 5*fsr + endtrl*fsr); % 5 s stim duration trl(:,3) = round(begtrl*fsr);exp_phases = {'study' 'test'};trl(:,4) = find( strcmp(exp_phases, runinfo.phase ));% TODO fix for naturals2 subjects: only take first naturalsstimcategories = {'fractals' 'landscapes' 'naturals1' 'streets1' 'streets2'};trl(:,5) = find(strcmp(stimcategories, runinfo.category ));% get stim pic nr from trgval stringsif trl(1,5) == 2 || trl(1,5) == 5 % for landscapes and streets2 format is imageXXX     pat = [exp_phases{trl(1,4)} ' image(\w*) Start'];else    pat = [exp_phases{trl(1,4)} ' (\w*) Start']; endtemp = regexp(trgval(trig_ind_stim)', pat, 'tokens'); temp = [temp{:}];   temp = [temp{:}];trl(:,6) = cellfun(@str2num, temp)';% get resp triggerstrig_ind_resp = find(cellfun(@isempty, strfind(trgval, 'Response')) == 0);% get quiz pic nr from trgval stringsif trl(1,5) == 2 || trl(1,5) == 5 % for landscapes and streets2 there is imageXXX    pat = [stimcategories{trl(1,5)} ' image(\w*) RT'];else    pat = [stimcategories{trl(1,5)} ' (\w*) RT'];endtemp = regexp(trgval(trig_ind_resp)', pat, 'tokens');temp = [temp{:}];temp = [temp{:}];if trl(1,4) == 1 % study phase    trl(:,7) = cellfun(@str2num, temp)';else    trl(:,7) = NaN; % no quiz pic in test phase    pic_resps = cellfun(@str2num, temp)'; % but check for omissions (max 10 s RT for test)        omissions = ismember(trl(:,6), pic_resps); % 0 for omissionsend% Get correctnessif trl(1,4) == 2 % test phase    studytrialinfo = cfg.studytrialinfo(cfg.studytrialinfo(:,2) == trl(1,5),:); % select category from study trialinfo    correct_ans = ismember(trl(:,6), studytrialinfo(:,3)) + 1; % NEW=1, OLD=2else    correct_ans = (trl(:,6) == trl(:,7)) + 1; end% trl(:,9) = trl(:,8) == correct_ans; % 0 is incorrect, 1 = correct TODO put old/new in col 8trl(:,8) = correct_ans; % put actual old/new in col 8% get response button if trl(1,4) == 1 % study phase    pat = 'Response (\w*) Quiz'; else    pat = 'Response (\w*) Test';    % for getting resp button out endtemp = regexp(trgval(trig_ind_resp)', pat, 'tokens'); temp = [temp{:}];   temp = [temp{:}];resps = zeros(length(trl),1);if runinfo.hand == 1    resps(find(strcmp('m', temp ))) = 1;    resps(find(strcmp('c', temp ))) = 2;else    resps(find(strcmp('c', temp ))) = 1;    resps(find(strcmp('m', temp ))) = 2;end% line up responses with corresponding stimsif trl(1,4) == 2 % test phase    resps_linedup = zeros(length(trl),1);    resps_linedup(omissions,:) = resps(resps>0);    trl(:,9) = resps_linedup; % TODO put resps in col 9else    trl(:,9) = resps; % no omissions possible for studyend% Get RTpat = 'RT (..\d*)'; temp = regexp(trgval(trig_ind_resp)', pat, 'tokens'); % get quiz pic nr from trgval stringstemp = [temp{:}];   temp = [temp{:}];if trl(1,4) == 2 % test phase    trl(omissions,10) = round(cellfun(@str2num, temp)' * 1000);else    trl(:,10) = round(cellfun(@str2num, temp)' * 1000);end